[gcode_macro SAFE_HOME_Z]
description: "Home Z com atÃ© 3 tentativas caso o BLTouch falhe"
gcode:
  G90
  G1 Z10 F300

  {% set max_attempts = 3 %}
  {% for i in range(1, max_attempts + 1) %}
    RESPOND PREFIX="info" MSG="Tentativa {{ i }} de homing Z..."
    PROBE
    {% if printer.toolhead.position.z > 0 %}
      RESPOND PREFIX="info" MSG="Homing Z bem-sucedido na tentativa {{ i }}"
      {% break %}
    {% else %}
      RESPOND PREFIX="warn" MSG="Falha na tentativa {{ i }}, levantando Z para tentar novamente..."
      G91
      G1 Z10 F300
      G90
    {% endif %}
  {% endfor %}

  {% if printer.toolhead.position.z <= 0 %}
    RESPOND PREFIX="error" MSG="Todas as tentativas de homing Z falharam. Verifique o BLTouch."
    M112
  {% endif %}
