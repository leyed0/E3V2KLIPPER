[gcode_macro SAFE_HOME_Z]
gcode:
  {% if attempt <= 3 %}
    RESPOND PREFIX="info" MSG="Tentativa { attempt } de homing Z..."
    TRY:
      G28 Z
    FAIL:
      RESPOND PREFIX="warn" MSG="Tentativa { attempt } falhou. Levantando Z e tentando novamente..."
      G91
      G1 Z10 F300
      G90
      SET_GCODE_VARIABLE MACRO=SAFE_HOME_Z VARIABLE=attempt VALUE={ attempt + 1 }
      _RETRY_HOME_Z
  {% else %}
    RESPOND PREFIX="error" MSG="BLTouch falhou apÃ³s 3 tentativas. Verifique o sensor."
    M112
  {% endif %}

[delayed_gcode INIT]
initial_duration: 0.1
gcode:
  SET_GCODE_VARIABLE MACRO=SAFE_HOME_Z VARIABLE=attempt VALUE=1
