[gcode_macro SAFE_HOME_Z]
description: "Homing Z com verificação e retentativa automática do BLTouch"
gcode:
  {% set max_retries = 3 %}
  {% set retry = 0 %}

  G90
  G1 Z10 F300  ; levanta o eixo Z antes de iniciar
  {% while retry < max_retries %}
    {% try %}
      G28 Z
      RESPOND PREFIX="info" MSG="BLTouch: Homing Z concluído com sucesso na tentativa {{ retry + 1 }}."
      {% break %}
    {% except %}
      RESPOND PREFIX="warn" MSG="BLTouch falhou na tentativa {{ retry + 1 }}, movendo Z para cima e tentando novamente..."
      G91
      G1 Z10 F300
      G90
      {% set retry = retry + 1 %}
  {% endwhile %}

  {% if retry >= max_retries %}
    RESPOND PREFIX="error" MSG="BLTouch falhou após {{ max_retries }} tentativas. Verifique o sensor!"
    M112 ; emergência
  {% endif %}
